version: '3.1'

services:

  hazelcast-payara:
    build: ./hazelcast
    volumes:
      - ./hazelcast/src/main/docker/hazelcast_default.xml:/opt/payara/config/hazelcast.xml
    expose:
      - "5701"        # the outbound Hazelcast port
      - "54327"       # the multicast Hazelcast port
    ports:
      - "18080:8080"  # the HTTP endpoint
    networks:
      - datanet

  mqtt-source:
    build: ./sources/mqtt
    ports:
      - "18081:8080"  # the HTTP endpoint
    depends_on:
      - eclipse-mosquitto
    links:
      - eclipse-mosquitto
    networks:
      - datanet

  csv-source:
    build: ./sources/csv
    volumes:
      - ./sources/csv/import.csv:/data/import.csv
    ports:
      - "18082:8080"  # the HTTP endpoint
    depends_on:
      - message-queue
    links:
      - message-queue
    networks:
      - datanet

  weather-source:
    build: ./sources/rest
    ports:
      - "18083:8080"  # the HTTP endpoint
    depends_on:
      - message-queue
    links:
      - message-queue
    networks:
      - datanet

  weather-processor:
    build: ./processors/weather
    ports:
      - "18084:8080"  # the HTTP endpoint
    depends_on:
      - message-queue
    links:
      - message-queue
    networks:
      - datanet

  eclipse-mosquitto:
    image: eclipse-mosquitto:1.4.12
    ports:
      - "1883:1883"
      - "9001:9001"
    networks:
      - datanet

  rabbit-mq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - datanet

  message-queue:
    image: rmohr/activemq:5.14.3
    expose:
      - "61616"       # the JMS port
    ports:
      - "8161:8161"   # the admin web UI
    networks:
      - datanet

  cockroach1:
    image: cockroachdb/cockroach:v1.1.5
    hostname: cockroach1
    command: start --insecure
    ports:
      - "26257:26257"
      - "8080:8080"
    volumes:
      - "${PWD}/cockroach/data/cockroach1:/cockroach/cockroach-data"
    networks:
      - datanet

  cockroach2:
    image: cockroachdb/cockroach:v1.1.5
    hostname: cockroach2
    command: start --insecure --join=cockroach1
    volumes:
      - "${PWD}/cockroach/data/cockroach2:/cockroach/cockroach-data"
    depends_on:
      - cockroach1
    links:
      - cockroach1
    networks:
      - datanet

  cockroach3:
    image: cockroachdb/cockroach:v1.1.5
    hostname: cockroach3
    command: start --insecure --join=cockroach1
    volumes:
      - "${PWD}/cockroach/data/cockroach3:/cockroach/cockroach-data"
    depends_on:
      - cockroach1
    links:
      - cockroach1
    networks:
      - datanet

  database:
    image: postgres:9.6.2
    ports:
      - "5432:5432"   # the Postgres port
    networks:
      - datanet

networks:
  datanet:
    driver: bridge
